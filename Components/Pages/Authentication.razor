@page "/"
@inject IAuthService AuthService
@inject NavigationManager Navigation

<div class="auth-container">
    <div class="auth-split">

        <!-- LEFT -->
        <div class="brand-section">
            <img src="image/MindSpace.png" alt="MindSpace" />
        </div>

        <!-- RIGHT -->
        <div class="form-section">
            <div class="form-card">

                <div class="user-avatar">
                    <svg width="65" height="65" viewBox="0 0 80 80">
                        <circle cx="40" cy="40" r="40" fill="#f5d9e2"/>
                        <circle cx="40" cy="30" r="12" stroke="#000" stroke-width="2" fill="none"/>
                        <path d="M 25 55 Q 40 48 55 55" stroke="#000" stroke-width="2" fill="none"/>
                    </svg>
                </div>

                <h2 class="form-title">@(isSignUp ? "SIGN UP" : "LOGIN")</h2>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">@errorMessage</div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="success-message">@successMessage</div>
                }

                <div class="form-group">
                    <input type="email"
                           @bind="email"
                           class="form-input"
                           placeholder="Email address"
                           @onkeyup="ClearMessages"/>
                </div>

                <div class="form-group">
                    <div class="password-input-wrapper">
                        <input type="@(showPassword ? "text" : "password")"
                               @bind="password"
                               class="form-input"
                               placeholder="Password"
                               @onkeyup="ClearMessages"/>
                        <button type="button"
                                class="toggle-password"
                                @onclick="() => showPassword = !showPassword">
                            <svg width="20" height="20" viewBox="0 0 20 20">
                                <path d="M10 4C5 4 1.73 7.11 1 10c.73 2.89 4 6 9 6s8.27-3.11 9-6c-.73-2.89-4-6-9-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"
                                      fill="currentColor"/>
                                <circle cx="10" cy="10" r="2" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>

                @if (isSignUp)
                {
                    <div class="form-group">
                        <div class="password-input-wrapper">
                            <input type="@(showConfirmPassword ? "text" : "password")"
                                   @bind="confirmPassword"
                                   class="form-input"
                                   placeholder="Confirm Password"
                                   @onkeyup="ClearMessages"/>
                            <button type="button"
                                    class="toggle-password"
                                    @onclick="() => showConfirmPassword = !showConfirmPassword">
                                <svg width="20" height="20" viewBox="0 0 20 20">
                                    <path d="M10 4C5 4 1.73 7.11 1 10c.73 2.89 4 6 9 6s8.27-3.11 9-6c-.73-2.89-4-6-9-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"
                                          fill="currentColor"/>
                                    <circle cx="10" cy="10" r="2" fill="currentColor"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="agreeToTerms"/>
                            <span>I agree with all the <a href="#" class="link">terms & conditions</a></span>
                        </label>
                    </div>
                }

                <button type="button" class="submit-button" @onclick="HandleSubmit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>@(isSignUp ? "Sign up" : "Login")</span>
                    }
                </button>

                <div class="toggle-mode">
                    <button type="button" @onclick="ToggleMode" class="text-button">
                        @(isSignUp ? "Already have an account? Login" : "Don't have an account? Sign up")
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Tab Navigation on Left Side -->
    <div class="tab-navigation">
        <button class="tab-button @(isSignUp ? "" : "active")" @onclick="() => SwitchToLogin()">
            LOGIN
        </button>
        <button class="tab-button @(isSignUp ? "active" : "")" @onclick="() => SwitchToSignUp()">
            SIGN UP
        </button>
    </div>
</div>

@code {
    private bool isSignUp = false;
    private bool showPassword = false;
    private bool showConfirmPassword = false;
    private bool isLoading = false;
    private bool agreeToTerms = false;

    private string email = "";
    private string password = "";
    private string confirmPassword = "";
    private string errorMessage = "";
    private string successMessage = "";
    
    protected override async Task OnInitializedAsync()
    {
        await AuthService.TryRestoreSessionAsync();
        if (AuthService.IsAuthenticated())
        {
            Navigation.NavigateTo("/pin", true);
        }
    }

    private void ToggleMode()
    {
        isSignUp = !isSignUp;
        ClearForm();
    }

    private void SwitchToLogin()
    {
        isSignUp = false;
        ClearForm();
    }

    private void SwitchToSignUp()
    {
        isSignUp = true;
        ClearForm();
    }

    private void ClearForm()
    {
        email = "";
        password = "";
        confirmPassword = "";
        agreeToTerms = false;
        errorMessage = "";
        successMessage = "";
    }

    private void ClearMessages()
    {
        errorMessage = "";
        successMessage = "";
    }

    private async Task HandleSubmit()
    {
        errorMessage = "";
        successMessage = "";
        isLoading = true;

        try
        {
            if (isSignUp)
            {
                var request = new RegisterRequest
                {
                    Email = email,
                    Password = password,
                    ConfirmPassword = confirmPassword,
                    AgreeToTerms = agreeToTerms
                };

                var (success, message) = await AuthService.RegisterAsync(request);

                if (success)
                {
                    successMessage = message;
                    await Task.Delay(1000);
                    Navigation.NavigateTo("/pin-setup", true);
                }
                else
                {
                    errorMessage = message;
                }
            }
            else
            {
                var request = new LoginRequest
                {
                    Email = email,
                    Password = password
                };

                var (success, message, user) = await AuthService.LoginAsync(request);

                if (success)
                {
                    successMessage = message;
                    await Task.Delay(1000);
                    Navigation.NavigateTo("/pin", true);

                }
                else
                {
                    errorMessage = message;
                }
            }
        }
        finally
        {
            isLoading = false;
        }
    }
}