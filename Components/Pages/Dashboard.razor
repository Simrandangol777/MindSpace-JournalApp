@page "/dashboard"
@inject IAuthService AuthService
@inject IDashboardService DashboardService
@inject NavigationManager Navigation

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Track your journaling journey and insights</p>
    </div>

    @if (isLoading)
    {
        <div class="dashboard-loading">
            <div class="dashboard-loading-spinner"></div>
            <p class="dashboard-loading-text">Loading your statsâ€¦</p>
        </div>
    }
    else
    {
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon stat-icon-flame">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Current Streak</span>
                <span class="stat-value">@currentStreak</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-trophy">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 21h8M12 17v4M7 4h10v4a5 5 0 01-10 0V4zM7 4V2h10v2M7 8h10M5 8H4a2 2 0 00-2 2v2a2 2 0 002 2h1M19 8h1a2 2 0 012 2v2a2 2 0 01-2 2h-1M8 12h8"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Longest Streak</span>
                <span class="stat-value">@longestStreak</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-calendar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Missed Days</span>
                <span class="stat-value">@missedDays</span>
            </div>
        </div>
    </div>

    <div class="analytics-grid">
        <div class="analytics-card">
            <h3 class="card-title">Mood Distribution</h3>
            @if (Total == 0)
            {
                <div class="chart-empty">
                    <p class="chart-empty-text">No entries yet.</p>
                    <p class="chart-empty-hint">Start journaling to see your mood breakdown.</p>
                </div>
            }
            else
            {
                <div class="chart-mood-dist">
                    <div class="donut-wrap">
                        <svg class="donut" width="180" height="180" viewBox="0 0 180 180">
                            @if (PositivePct > 0)
                            {
                                <circle class="donut-segment donut-positive" cx="90" cy="90" r="72" fill="none" stroke-width="24"
                                        stroke-dasharray="@(PositivePct * 4.52) 452" transform="rotate(-90 90 90)"/>
                            }
                            @if (NeutralPct > 0)
                            {
                                <circle class="donut-segment donut-neutral" cx="90" cy="90" r="72" fill="none" stroke-width="24"
                                        stroke-dasharray="@(NeutralPct * 4.52) 452" stroke-dashoffset="@(-PositivePct * 4.52)" transform="rotate(-90 90 90)"/>
                            }
                            @if (NegativePct > 0)
                            {
                                <circle class="donut-segment donut-negative" cx="90" cy="90" r="72" fill="none" stroke-width="24"
                                        stroke-dasharray="@(NegativePct * 4.52) 452" stroke-dashoffset="@(-(PositivePct + NeutralPct) * 4.52)" transform="rotate(-90 90 90)"/>
                            }
                        </svg>
                    </div>
                    <div class="legend">
                        <div class="legend-item"><span class="legend-dot legend-positive"></span><span>Positive @PositivePct%</span></div>
                        <div class="legend-item"><span class="legend-dot legend-neutral"></span><span>Neutral @NeutralPct%</span></div>
                        <div class="legend-item"><span class="legend-dot legend-negative"></span><span>Negative @NegativePct%</span></div>
                    </div>
                </div>
            }
        </div>

        <div class="analytics-card">
            <h3 class="card-title">Most Frequent Moods</h3>
            @if (stats?.MoodFrequency == null || !stats.MoodFrequency.Any())
            {
                <div class="chart-empty">
                    <p class="chart-empty-text">No mood data yet.</p>
                    <p class="chart-empty-hint">Add moods to your entries to see trends.</p>
                </div>
            }
            else
            {
                <div class="chart-bars">
                    @foreach (var kv in stats.MoodFrequency.OrderByDescending(x => x.Value).Take(5))
                    {
                        <div class="bar-row">
                            <span class="bar-label">@kv.Key</span>
                            <div class="bar-track">
                                <div class="bar-fill" style="width: @(MoodBarWidth(kv.Value).ToString("0", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                            </div>
                            <span class="bar-value">@kv.Value</span>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="analytics-card">
            <h3 class="card-title">Word Count Trends</h3>
            @if (WordTrend.Count == 0)
            {
                <div class="chart-empty">
                    <p class="chart-empty-text">No entries yet.</p>
                    <p class="chart-empty-hint">Your word count over time will appear here.</p>
                </div>
            }
            else
            {
                <div class="chart-trend">
                    <svg class="trend-svg" viewBox="0 0 360 160" preserveAspectRatio="xMidYMid meet">
                        <polyline class="trend-line" points="@BuildPolyline()" fill="none"/>
                        @for (int i = 0; i < WordTrend.Count; i++)
                        {
                            var max = Math.Max(1, WordTrend.Max(x => x.Words));
                            var minX = 20; var maxX = 340; var minY = 20; var maxY = 140;
                            var step = WordTrend.Count == 1 ? 0 : (double)(maxX - minX) / (WordTrend.Count - 1);
                            var x = minX + (step * i);
                            var y = maxY - ((WordTrend[i].Words / (double)max) * (maxY - minY));
                            <circle class="trend-dot" cx="@x.ToString(System.Globalization.CultureInfo.InvariantCulture)" cy="@y.ToString(System.Globalization.CultureInfo.InvariantCulture)" r="5"/>
                        }
                    </svg>
                    <p class="trend-avg">Average: @AvgWords.ToString("0", System.Globalization.CultureInfo.InvariantCulture) words/entry</p>
                </div>
            }
        </div>

        <div class="analytics-card">
            <h3 class="card-title">Most Used Tags</h3>
            @if (stats?.TagUsage == null || !stats.TagUsage.Any())
            {
                <div class="chart-empty">
                    <p class="chart-empty-text">No tags yet.</p>
                    <p class="chart-empty-hint">Tag your entries to see popular topics.</p>
                </div>
            }
            else
            {
                <div class="chart-bars">
                    @foreach (var kv in stats.TagUsage.OrderByDescending(x => x.Value).Take(10))
                    {
                        <div class="bar-row">
                            <span class="bar-label">@kv.Key</span>
                            <div class="bar-track">
                                <div class="bar-fill bar-fill-alt" style="width: @(TagBarWidth(kv.Value).ToString("0", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                            </div>
                            <span class="bar-value">@kv.Value</span>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
    }
</div>

@code {
    private int Total => stats?.TotalEntries ?? 0;
    private int PositiveCount => stats?.MoodDistribution.GetValueOrDefault("Positive") ?? 0;
    private int NeutralCount => stats?.MoodDistribution.GetValueOrDefault("Neutral") ?? 0;
    private int NegativeCount => stats?.MoodDistribution.GetValueOrDefault("Negative") ?? 0;
    private int PositivePct => Total == 0 ? 0 : (int)Math.Round(PositiveCount * 100.0 / Total);
    private int NeutralPct => Total == 0 ? 0 : (int)Math.Round(NeutralCount * 100.0 / Total);
    private int NegativePct => Math.Max(0, 100 - PositivePct - NeutralPct);

    private int MaxMoodCount => stats?.MoodFrequency?.Values.DefaultIfEmpty(1).Max() ?? 1;
    private int MaxTagCount => stats?.TagUsage?.Values.DefaultIfEmpty(1).Max() ?? 1;
    private double MoodBarWidth(int count) => MaxMoodCount == 0 ? 0 : (count * 100.0 / MaxMoodCount);
    private double TagBarWidth(int count) => MaxTagCount == 0 ? 0 : (count * 100.0 / MaxTagCount);

    private List<(string Label, int Words)> WordTrend = new();
    private DashboardStats? stats;
    private bool isLoading = true;
    private double AvgWords => stats?.AverageWordCount ?? 0;
    private int currentStreak => stats?.CurrentStreak ?? 0;
    private int longestStreak => stats?.LongestStreak ?? 0;
    private int missedDays => stats?.MissedDays ?? 0;

    private string BuildPolyline()
    {
        if (WordTrend.Count == 0) return "";
        var max = Math.Max(1, WordTrend.Max(x => x.Words));
        var minX = 20; var maxX = 340; var minY = 20; var maxY = 140;
        var step = WordTrend.Count == 1 ? 0 : (double)(maxX - minX) / (WordTrend.Count - 1);
        var points = new List<string>();
        for (int i = 0; i < WordTrend.Count; i++)
        {
            var x = minX + (step * i);
            var y = maxY - ((WordTrend[i].Words / (double)max) * (maxY - minY));
            points.Add($"{x:0},{y:0}");
        }
        return string.Join(" ", points);
    }

    private async Task LoadDashboardStats()
    {
        isLoading = true;
        var user = AuthService.GetCurrentUser();
        if (user != null)
        {
            stats = await DashboardService.GetStatsAsync(user.Id);
            var entries = await DashboardService.GetRecentEntriesAsync(user.Id, 8);
            WordTrend = entries.OrderBy(e => e.Date).Select(e => (e.Date.ToString("MM/dd"), e.WordCount)).ToList();
        }
        isLoading = false;
    }

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated()) { Navigation.NavigateTo("/", true); return; }
        await LoadDashboardStats();
    }
}
